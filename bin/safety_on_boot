#!/bin/bash

set -e 

pushd /copycat
GIT_SSH_COMMAND="ssh -i /copycat/keys/system/ssh.key" git

M_ID=$(cat /etc/machine-id)
ACTIVE_CONF=$(cat active-config)
BRANCH="copycat@${ACTIVE_CONF}@${M_ID"

${GIT_SSH_COMMAND} branch ${BRANCH} 2>/dev/null
${GIT_SSH_COMMAND} checkout ${BRANCH}

GENS=$(nixos-rebuild list-generations)
G_HEAD=$(cat ${GENS} | head -n 1)
GEN=$(cat ${GENS} | grep current)
${GIT_SSH_COMMAND} commit --allow-empty -am "
${BRANCH}

${G_HEAD}
${GEN}

.mew
"

${GIT_SSH_COMMAND} push --set-upstream origin ${BRANCH}

read -p "i wonder if i can do this here lol"
